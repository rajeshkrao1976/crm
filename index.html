<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raveone ¬∑ ERPNext‚ÄëStyle Desk</title>

    <!-- Oat UI ‚Äì ultra‚Äëlight, semantic, zero dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/oat-ui@latest/dist/oat.min.css">

    <!-- Alpine.js ‚Äì reactive, declarative -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome 6 ‚Äì ERPNext‚Äëstyle icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Font: Inter ‚Äì modern, clean -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Quill.js ‚Äì rich text editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* ---------- ERPNext / Frappe Design System (V13/V15 Espresso) ---------- */
        :root {
            --brand-blue: #2563eb;
            --brand-blue-dark: #1e40af;
            --brand-blue-light: #dbeafe;
            --bg-page: #f9fafb;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --bg-sidebar-hover: #f3f4f6;
            --bg-active: #eff6ff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-light: #f0f0f0;
            --shadow-card: 0 2px 6px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-hover: 0 8px 20px rgba(0,0,0,0.04);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-page: #111827;
                --bg-card: #1f2937;
                --bg-sidebar: #1f2937;
                --bg-sidebar-hover: #374151;
                --bg-active: #2563eb20;
                --text-primary: #f9fafb;
                --text-secondary: #d1d5db;
                --text-muted: #9ca3af;
                --border-light: #374151;
                --shadow-card: 0 4px 12px rgba(0,0,0,0.2);
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
        }
        [x-cloak] { display: none !important; }

        /* ERPNext Desk Layout */
        .erp-desk { display: flex; min-height: 100vh; }

        /* ---------- Left Sidebar (Persistent) ---------- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .sidebar-header i {
            font-size: 1.75rem;
            color: var(--brand-blue);
        }
        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0 0.75rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.1s;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }
        .nav-item i {
            width: 1.5rem;
            color: var(--text-muted);
        }
        .nav-item:hover {
            background: var(--bg-sidebar-hover);
            color: var(--text-primary);
        }
        .nav-item.active {
            background: var(--bg-active);
            color: var(--brand-blue);
            font-weight: 600;
        }
        .nav-item.active i {
            color: var(--brand-blue);
        }

        /* ---------- Main Content Area ---------- */
        .main-content {
            flex: 1;
            padding: 2rem;
            background: var(--bg-page);
            overflow-y: auto;
        }

        /* ERPNext‚Äëstyle cards */
        .frappe-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
            transition: box-shadow 0.2s;
        }
        .frappe-card:hover {
            box-shadow: var(--shadow-hover);
        }

        /* KPI grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .kpi-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
        }
        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        /* ERPNext 3‚Äëcolumn form */
        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.375rem;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: var(--font-sans);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 3px var(--brand-blue-light);
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--brand-blue);
            color: white;
        }
        .btn-primary:hover {
            background: var(--brand-blue-dark);
        }
        .btn-secondary {
            background: var(--bg-sidebar-hover);
            color: var(--text-primary);
        }

        /* Tables */
        .frappe-table {
            width: 100%;
            border-collapse: collapse;
        }
        .frappe-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-light);
        }
        .frappe-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        .frappe-table tbody tr:hover {
            background: var(--bg-sidebar-hover);
        }

        /* Status pills */
        .status-pill {
            display: inline-block;
            padding: 0.2rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-pill.running { background: #dcfce7; color: #166534; }
        .status-pill.draft { background: #f3f4f6; color: #4b5563; }
        @media (prefers-color-scheme: dark) {
            .status-pill.running { background: #14532d; color: #bbf7d0; }
            .status-pill.draft { background: #374151; color: #e5e7eb; }
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 480px;
            max-width: 90%;
        }

        /* Quill editor customization */
        .ql-editor {
            min-height: 300px;
            font-family: var(--font-sans);
        }
        .ql-toolbar {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-color: var(--border-light) !important;
        }
        .ql-container {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-color: var(--border-light) !important;
        }
    </style>
</head>
<body>

<!-- ========== ALPINE STORE INITIALIZATION ========== -->
<script>
    document.addEventListener('alpine:init', () => {
        // ---------- INITIALISE EMPTY STORES ‚Äì READY FOR REAL DATA ----------
        Alpine.store('auth', { authenticated: false });
        Alpine.store('stats', { total: 0, quota: 0, pipelineValue: 0 });
        Alpine.store('campaigns', []);
        Alpine.store('deals', []);
        Alpine.store('templates', []);
        Alpine.store('contacts', []);
    });
</script>

<!-- ========== AUTH OVERLAY ========== -->
<div x-data="{ token: '' }" 
     x-show="!$store.auth.authenticated" 
     x-cloak
     class="modal-overlay" style="background: rgba(17,24,39,0.95); backdrop-filter: blur(4px);">
    <div class="modal-content" style="width: 400px;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <i class="fas fa-cube" style="font-size: 2rem; color: var(--brand-blue);"></i>
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin:0;">Raveone</h2>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Enter your access token to continue.</p>
        <input type="password" x-model="token" placeholder="Access token" 
               style="width:100%; padding:0.75rem 1rem; border:1px solid var(--border-light); border-radius:0.5rem; margin-bottom:1.5rem; background: var(--bg-card); color: var(--text-primary);">
        <button @click="
            if (token === 'RAVE-ACCESS-2025') {
                $store.auth.authenticated = true;
                // üî• LOAD REAL DATA IMMEDIATELY AFTER AUTH
                loadRealData();
            } else {
                alert('Access denied');
            }
        " class="btn btn-primary" style="width:100%;">
            <i class="fas fa-key"></i> Verify Access
        </button>
    </div>
</div>

<!-- ========== MAIN DESK ‚Äì ERPNext LAYOUT ========== -->
<div x-data="{ 
        activeNav: 'dashboard',
        showDealModal: false,
        showTemplateMenu: false,
        quill: null
     }" 
     x-show="$store.auth.authenticated" 
     x-cloak
     class="erp-desk"
     x-init="
        $watch('activeNav', value => {
            if (value === 'wizard' && !quill) {
                setTimeout(() => {
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ header: [1,2,3,false] }],
                                ['bold', 'italic', 'underline'],
                                ['link', 'clean']
                            ]
                        }
                    });
                }, 50);
            }
        });
     ">

    <!-- ========== SIDEBAR NAVIGATION ========== -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-cube"></i>
            <h1>Raveone</h1>
        </div>
        <div class="sidebar-nav">
            <button @click="activeNav = 'dashboard'" 
                    class="nav-item" 
                    :class="{ 'active': activeNav === 'dashboard' }">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
            <button @click="activeNav = 'crm'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'crm' }">
                <i class="fas fa-users"></i>
                <span>CRM</span>
            </button>
            <button @click="activeNav = 'campaigns'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'campaigns' }">
                <i class="fas fa-paper-plane"></i>
                <span>Mailings</span>
            </button>
            <button @click="activeNav = 'templates'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'templates' }">
                <i class="fas fa-file-alt"></i>
                <span>Templates</span>
            </button>
            <button @click="activeNav = 'settings'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'settings' }">
                <i class="fas fa-cog"></i>
                <span>Configuration</span>
            </button>
            <button @click="activeNav = 'wizard'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'wizard' }">
                <i class="fas fa-pen"></i>
                <span>Composer</span>
            </button>
        </div>
        <div style="padding: 1.5rem 1.5rem 0; border-top: 1px solid var(--border-light); margin-top: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-cloud"></i>
                <span x-text="$store.stats.quota + ' / 1500 daily'"></span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem;">
                <span x-text="$store.stats.total + ' contacts'"></span>
            </div>
        </div>
    </div>

    <!-- ========== MAIN CONTENT AREA ========== -->
    <div class="main-content">

        <!-- ===== DASHBOARD PAGE ===== -->
        <div x-show="activeNav === 'dashboard'">
            <div class="kpi-grid">
                <div class="kpi-item">
                    <div class="kpi-label">Total Contacts</div>
                    <div class="kpi-value" x-text="$store.stats.total.toLocaleString()"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Pipeline Value</div>
                    <div class="kpi-value" x-text="'‚Çπ' + ($store.stats.pipelineValue || 0).toLocaleString()"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Daily Quota</div>
                    <div class="kpi-value" x-text="$store.stats.quota"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Active Drips</div>
                    <div class="kpi-value" x-text="$store.campaigns.filter(c => c.status === 'Running').length"></div>
                </div>
            </div>

            <div class="frappe-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 600;">üì¨ Recent Mailings</h3>
                    <button @click="activeNav = 'campaigns'" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New Campaign
                    </button>
                </div>
                <table class="frappe-table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Status</th><th>Limit</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="c in $store.campaigns.slice(0,3)" :key="c.id">
                            <tr>
                                <td x-text="c.name"></td>
                                <td x-text="c.subject"></td>
                                <td><span class="status-pill" :class="c.status?.toLowerCase()" x-text="c.status || 'Draft'"></span></td>
                                <td x-text="c.limit"></td>
                            </tr>
                        </template>
                        <tr x-show="$store.campaigns.length === 0">
                            <td colspan="4" style="text-align:center; color: var(--text-muted);">No campaigns yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== CRM PAGE ===== -->
        <div x-show="activeNav === 'crm'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Deal Pipeline</h2>
                <button @click="showDealModal = true" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Opportunity
                </button>
            </div>

            <!-- Pipeline tabs (static for now) -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button class="btn btn-secondary">Recruitment</button>
                <button class="btn btn-secondary">Training</button>
                <button class="btn btn-secondary">Consulting</button>
            </div>

            <div class="frappe-card">
                <table class="frappe-table">
                    <thead>
                        <tr><th>Opportunity</th><th>Company</th><th>Value</th><th>Contact</th><th>Stage</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="d in $store.deals" :key="d.id">
                            <tr>
                                <td><span style="font-weight:600;" x-text="d.name"></span></td>
                                <td x-text="d.business"></td>
                                <td x-text="'‚Çπ' + (d.value || 0).toLocaleString()"></td>
                                <td x-text="d.contactEmail || '‚Äî'"></td>
                                <td>
                                    <select @change="updateDealStage(d.id, $event.target.value)" 
                                            style="background: var(--bg-sidebar-hover); border: none; padding: 0.25rem 0.75rem; border-radius: 2rem;">
                                        <option value="New" :selected="d.stage === 'New'">New</option>
                                        <option value="Discovery" :selected="d.stage === 'Discovery'">Discovery</option>
                                        <option value="Proposal" :selected="d.stage === 'Proposal'">Proposal</option>
                                        <option value="Won" :selected="d.stage === 'Won'">Won</option>
                                    </select>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.deals.length === 0">
                            <td colspan="5" style="text-align:center; color: var(--text-muted);">No deals yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== CAMPAIGNS PAGE ===== -->
        <div x-show="activeNav === 'campaigns'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Email Campaigns</h2>
                <button @click="activeNav = 'wizard'" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Create New
                </button>
            </div>
            <div class="frappe-card">
                <table class="frappe-table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Segment</th><th>Limit</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody>
                        <template x-for="c in $store.campaigns" :key="c.id">
                            <tr>
                                <td x-text="c.name"></td>
                                <td x-text="c.subject"></td>
                                <td x-text="c.segment || 'All'"></td>
                                <td x-text="c.limit"></td>
                                <td><span class="status-pill" :class="c.status?.toLowerCase()" x-text="c.status || 'Draft'"></span></td>
                                <td>
                                    <button @click="toggleCampaignStatus(c.id)" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">
                                        <span x-text="c.status === 'Running' ? 'Stop' : 'Start'"></span>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.campaigns.length === 0">
                            <td colspan="6" style="text-align:center; color: var(--text-muted);">No campaigns yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== TEMPLATES PAGE ===== -->
        <div x-show="activeNav === 'templates'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Template Library</h2>
                <button @click="saveCurrentAsTemplate()" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Current
                </button>
            </div>
            <div class="frappe-card">
                <table class="frappe-table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Category</th><th></th></tr>
                    </thead>
                    <tbody>
                        <template x-for="t in $store.templates" :key="t.id">
                            <tr>
                                <td x-text="t.name"></td>
                                <td x-text="t.subject"></td>
                                <td x-text="t.category || 'General'"></td>
                                <td>
                                    <button @click="useTemplate(t.id); activeNav = 'wizard'" class="btn btn-secondary" style="padding:0.25rem 0.75rem; margin-right:0.5rem;">
                                        Use
                                    </button>
                                    <button @click="deleteTemplate(t.id)" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.templates.length === 0">
                            <td colspan="4" style="text-align:center; color: var(--text-muted);">No templates yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== SETTINGS PAGE (ERPNext 3‚Äëcolumn form) ===== -->
        <div x-show="activeNav === 'settings'">
            <h2 style="font-size:1.25rem; font-weight:600; margin-bottom:1.5rem;">Configuration</h2>
            <div class="frappe-card">
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Apps Script URL</label>
                        <input type="text" id="conf-gas-url" placeholder="https://script.google.com/macros/s/AKfycbw-BCKTdVmrxdkMIxa4o7vnojE24Ezd_SDu9ynxNVSxAJnhAibHpWsqUetHHLZU6aeB9A/exec">
                    </div>
                    <div class="form-group">
                        <label>Master Key</label>
                        <input type="password" id="conf-master-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>Sender Name</label>
                        <input type="text" id="conf-sender-name" placeholder="Raveone Consultants">
                    </div>
                    <div class="form-group">
                        <label>Reply‚ÄëTo</label>
                        <input type="email" id="conf-reply-addr" placeholder="contact@yourdomain.com">
                    </div>
                    <div class="form-group">
                        <label>Unsubscribe URL</label>
                        <input type="url" id="conf-unsubscribe-url" placeholder="https://yourdomain.com/unsubscribe?email={EMAIL}">
                    </div>
                    <div class="form-group">
                        <label>Gemini API Key</label>
                        <input type="password" id="conf-gemini-key" placeholder="AI key">
                    </div>
                    <div class="form-group">
                        <label>Spam Delay</label>
                        <select id="conf-spam-delay">
                            <option value="1">1s (fast)</option>
                            <option value="5" selected>5s (recommended)</option>
                            <option value="10">10s (strict)</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="conf-pixel" checked> Enable tracking pixel
                        </label>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                    <label>HTML Signature / Footer</label>
                    <textarea id="conf-footer" rows="6" placeholder="<br><hr><div>... {UNSUBSCRIBE_URL} ...</div>"></textarea>
                    <p style="font-size:0.75rem; color: var(--text-muted); margin-top:0.5rem;">Use {UNSUBSCRIBE_URL} placeholder. Saved to localStorage.</p>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
                    <button @click="saveSettings()" class="btn btn-primary">Save All Settings</button>
                </div>
            </div>
        </div>

        <!-- ===== WIZARD PAGE (Email Composer) ===== -->
        <div x-show="activeNav === 'wizard'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size:1.25rem; font-weight:600;">Compose New Mailing</h2>
                <div style="display: flex; gap: 0.75rem;">
                    <!-- Template dropdown -->
                    <div style="position: relative;">
                        <button @click="showTemplateMenu = !showTemplateMenu" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Load Template
                        </button>
                        <div x-show="showTemplateMenu" @click.away="showTemplateMenu = false" 
                             style="position: absolute; right: 0; top: 100%; width: 280px; background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 0.5rem; padding: 0.5rem; margin-top: 0.25rem; z-index: 50;">
                            <template x-for="t in $store.templates" :key="t.id">
                                <button @click="useTemplate(t.id); showTemplateMenu = false" style="display: block; width:100%; text-align: left; padding: 0.5rem; border-radius:0.375rem;" class="btn btn-secondary">
                                    <span x-text="t.name"></span>
                                </button>
                            </template>
                            <div x-show="$store.templates.length === 0" style="padding:0.5rem; color: var(--text-muted);">
                                No templates saved
                            </div>
                        </div>
                    </div>
                    <button @click="refineAI()" class="btn btn-primary" style="background: linear-gradient(135deg,#6366f1,#a855f7);">
                        ‚ú® AI Refine
                    </button>
                </div>
            </div>

            <div class="frappe-card" style="padding: 2rem;">
                <!-- Campaign metadata -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <input type="text" id="campName" placeholder="Campaign name" 
                               style="font-size: 1.5rem; font-weight: 600; border: none; border-bottom: 2px solid var(--border-light); width:100%; padding: 0.25rem 0;">
                        <input type="text" id="subA" placeholder="Email subject" 
                               style="margin-top: 1rem; width:100%;">
                    </div>
                    <div style="background: var(--bg-sidebar-hover); padding: 1.5rem; border-radius: 1rem;">
                        <div style="display: flex; gap: 1rem;">
                            <div style="flex:1;">
                                <label style="font-size:0.75rem; color: var(--text-secondary);">DAILY LIMIT</label>
                                <input type="number" id="campLimit" value="300" style="width:100%;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:0.75rem; color: var(--text-secondary);">SEGMENT (tag)</label>
                                <input type="text" id="campSegment" placeholder="e.g. MSME" style="width:100%;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Editor toolbar -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="font-size:0.75rem; color: var(--text-secondary);">Variables:</span>
                        <button @click="insertTag('{Name}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ Name</button>
                        <button @click="insertTag('{Business}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ Business</button>
                        <button @click="insertTag('{City}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ City</button>
                    </div>
                    <button @click="checkSpam()" class="btn btn-secondary" style="color:#b45309;">
                        ‚ö†Ô∏è Check Spam
                    </button>
                </div>

                <!-- Quill editor container -->
                <div id="editor" style="height: 320px;"></div>

                <!-- Action buttons -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button @click="activeNav = 'campaigns'" class="btn btn-secondary">Cancel</button>
                    <button @click="saveCampaign()" class="btn btn-primary">Save & Sync</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== NEW DEAL MODAL (Alpine) ===== -->
    <div x-show="showDealModal" x-cloak class="modal-overlay" @click.away="showDealModal = false">
        <div class="modal-content">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">Create Opportunity</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="text" id="dealName" placeholder="Deal name">
                <input type="text" id="dealCompany" placeholder="Company / Business">
                <input type="number" id="dealValue" placeholder="Value (‚Çπ)">
                <select id="dealPipeline">
                    <option value="Recruitment">Recruitment</option>
                    <option value="Training">Training</option>
                    <option value="Consulting">Consulting</option>
                </select>
                <select id="dealStage">
                    <option value="New">New</option>
                    <option value="Discovery">Discovery</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Won">Won</option>
                </select>
                <!-- Contact dropdown -->
                <select id="dealContactEmail">
                    <option value="">-- Link to contact (optional) --</option>
                    <template x-for="contact in $store.contacts" :key="contact.email">
                        <option :value="contact.email" x-text="contact.name + ' (' + contact.email + ')'"></option>
                    </template>
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <button @click="showDealModal = false" class="btn btn-secondary">Cancel</button>
                <button @click="saveDeal(); showDealModal = false" class="btn btn-primary">Create Deal</button>
            </div>
        </div>
    </div>
</div>

<!-- ========== JSONP & API HELPER FUNCTIONS ========== -->
<script>
    // ---------- JSONP ‚Äì CORS‚Äëfree calls to Apps Script ----------
    function jsonp(url) {
        return new Promise((resolve, reject) => {
            const cbName = 'jsonp_cb_' + Date.now() + '_' + Math.random().toString(36).substring(2,7);
            window[cbName] = function(data) {
                resolve(data);
                delete window[cbName];
                if (script.parentNode) script.parentNode.removeChild(script);
            };
            const script = document.createElement('script');
            const separator = url.includes('?') ? '&' : '?';
            script.src = url + separator + 'callback=' + cbName;
            script.onerror = () => reject(new Error('JSONP failed'));
            document.head.appendChild(script);
            setTimeout(() => {
                if (window[cbName]) {
                    reject(new Error('JSONP timeout'));
                    delete window[cbName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                }
            }, 15000);
        });
    }

    async function apiCall(action, params = {}) {
        const url = document.getElementById('conf-gas-url')?.value;
        if (!url) throw new Error('Apps Script URL not configured');
        const key = document.getElementById('conf-master-key')?.value || 'vibe-marketing-2024';
        const searchParams = new URLSearchParams({ action, key, ...params });
        Object.keys(params).forEach(k => {
            if (typeof params[k] === 'object') searchParams.set(k, JSON.stringify(params[k]));
        });
        const fullUrl = `${url}?${searchParams.toString()}`;
        const response = await jsonp(fullUrl);
        if (response?.error) throw new Error(response.error);
        return response;
    }

    // ---------- GLOBAL DATA LOADER ‚Äì FETCHES REAL BACKEND DATA ----------
    window.loadRealData = async function() {
        try {
            log('Loading real data from backend...');
            const [stats, campaigns, deals, contacts, templates] = await Promise.all([
                apiCall('getStatus').catch(() => ({ total: 0, quota: 0, pipelineValue: 0 })),
                apiCall('getCampaigns').catch(() => []),
                apiCall('getDeals').catch(() => []),
                apiCall('getContacts').catch(() => []),
                apiCall('getTemplates').catch(() => [])
            ]);

            Alpine.store('stats', stats);
            Alpine.store('campaigns', Array.isArray(campaigns) ? campaigns : []);
            Alpine.store('deals', Array.isArray(deals) ? deals : []);
            Alpine.store('contacts', Array.isArray(contacts) ? contacts : []);
            Alpine.store('templates', Array.isArray(templates) ? templates : []);

            log(`Data loaded: ${stats.total} contacts, ${deals.length} deals, ${campaigns.length} campaigns`);
        } catch (e) {
            log('Failed to load data: ' + e.message);
        }
    };

    // ---------- Global functions for Alpine ----------
    window.saveDeal = async function() {
        const newDeal = {
            id: Date.now().toString(),
            name: document.getElementById('dealName')?.value,
            business: document.getElementById('dealCompany')?.value,
            value: document.getElementById('dealValue')?.value,
            pipeline: document.getElementById('dealPipeline')?.value,
            stage: document.getElementById('dealStage')?.value,
            contactEmail: document.getElementById('dealContactEmail')?.value
        };
        try {
            await apiCall('saveDeal', { deal: newDeal });
            // Refresh deals list
            const deals = await apiCall('getDeals');
            Alpine.store('deals', deals);
            log('Deal created and synced');
        } catch(e) {
            console.error(e);
            alert('Failed to save deal: ' + e.message);
        }
    };

    window.updateDealStage = async function(id, stage) {
        try {
            await apiCall('updateDealStage', { id, stage });
            const deal = Alpine.store('deals').find(d => d.id == id);
            if (deal) deal.stage = stage;
        } catch(e) {
            console.error(e);
            alert('Failed to update stage: ' + e.message);
        }
    };

    window.toggleCampaignStatus = async function(id) {
        const campaign = Alpine.store('campaigns').find(c => c.id == id);
        const newStatus = campaign?.status === 'Running' ? 'Draft' : 'Running';
        try {
            await apiCall('toggleCampaignStatus', { id, status: newStatus });
            if (campaign) campaign.status = newStatus;
        } catch(e) {
            console.error(e);
            alert('Failed to toggle status: ' + e.message);
        }
    };

    window.saveCampaign = async function() {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        const body = quillEl?.root?.innerHTML || '';
        const signature = document.getElementById('conf-footer')?.value || '';
        const unsubscribeBase = document.getElementById('conf-unsubscribe-url')?.value || '';
        const finalBody = body + signature.replace(/{UNSUBSCRIBE_URL}/g, unsubscribeBase + '{EMAIL}');
        
        const newCampaign = {
            name: document.getElementById('campName')?.value || 'New Campaign',
            subject: document.getElementById('subA')?.value || 'No subject',
            body: finalBody,
            limit: document.getElementById('campLimit')?.value || 300,
            segment: document.getElementById('campSegment')?.value || ''
        };
        try {
            await apiCall('saveCampaign', { campaign: newCampaign });
            log('Campaign saved');
            // Refresh campaigns list
            const campaigns = await apiCall('getCampaigns');
            Alpine.store('campaigns', campaigns);
            Alpine.store('alpine').activeNav = 'campaigns';
        } catch(e) {
            console.error(e);
            alert('Failed to save campaign: ' + e.message);
        }
    };

    window.saveCurrentAsTemplate = async function() {
        const name = prompt('Template name:');
        if (!name) return;
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        const subject = document.getElementById('subA')?.value || '';
        const body = quillEl?.root?.innerHTML || '';
        const category = prompt('Category:') || 'General';
        try {
            await apiCall('saveTemplate', { template: { name, subject, body, category } });
            log('Template saved');
            // Refresh templates list
            const templates = await apiCall('getTemplates');
            Alpine.store('templates', templates);
        } catch(e) {
            console.error(e);
            alert('Failed to save template: ' + e.message);
        }
    };

    window.deleteTemplate = async function(id) {
        if (!confirm('Delete template?')) return;
        try {
            await apiCall('deleteTemplate', { id });
            Alpine.store('templates', Alpine.store('templates').filter(t => t.id != id));
        } catch(e) {
            console.error(e);
            alert('Failed to delete template: ' + e.message);
        }
    };

    window.useTemplate = function(id) {
        const t = Alpine.store('templates').find(t => t.id == id);
        if (t) {
            document.getElementById('campName').value = t.name + ' (Copy)';
            document.getElementById('subA').value = t.subject;
            const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
            if (quillEl) quillEl.clipboard.dangerouslyPasteHTML(t.body);
        }
    };

    window.refineAI = async function() {
        const key = document.getElementById('conf-gemini-key')?.value;
        if (!key) return alert('Gemini API key not configured');
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (!quillEl) return;
        const text = quillEl.getText();
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: 'Rewrite this for an MSME business owner. Be persuasive, direct, professional:\n' + text }] }] })
            });
            const data = await res.json();
            quillEl.root.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
            log('AI refinement applied');
        } catch(e) {
            console.error(e);
            alert('AI refinement failed: ' + e.message);
        }
    };

    window.insertTag = function(tag) {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (quillEl) {
            const range = quillEl.getSelection(true);
            quillEl.insertText(range?.index || quillEl.getLength(), tag);
        }
    };

    window.checkSpam = function() {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (!quillEl) return;
        const text = quillEl.getText().toLowerCase();
        const triggers = ['free','guarantee','winner','urgent','$$$','click here','act now','buy now','100%'];
        const found = triggers.filter(t => text.includes(t));
        alert(found.length ? '‚ö†Ô∏è Spam triggers: ' + found.join(', ') : '‚úÖ Clean');
    };

    window.saveSettings = function() {
        const ids = ['conf-gas-url','conf-master-key','conf-sender-name','conf-reply-addr',
                     'conf-unsubscribe-url','conf-gemini-key','conf-spam-delay','conf-footer'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) localStorage.setItem('rave_' + id, el.value);
        });
        localStorage.setItem('rave_conf-pixel', document.getElementById('conf-pixel')?.checked || false);
        alert('Settings saved to localStorage');
    };

    window.log = function(msg) {
        console.log('[Raveone]', msg);
        const logsEl = document.getElementById('logs');
        if (logsEl) logsEl.innerHTML = `> ${new Date().toLocaleTimeString()}: ${msg}<br>` + logsEl.innerHTML;
    };

    // ---------- Load settings from localStorage ----------
    window.addEventListener('load', () => {
        const defaultUrl = 'https://script.google.com/macros/s/AKfycbw-BCKTdVmrxdkMIxa4o7vnojE24Ezd_SDu9ynxNVSxAJnhAibHpWsqUetHHLZU6aeB9A/exec'; // üîÅ REPLACE WITH YOUR DEPLOYED URL
        document.getElementById('conf-gas-url').value = localStorage.getItem('rave_conf-gas-url') || defaultUrl;
        document.getElementById('conf-master-key').value = localStorage.getItem('rave_conf-master-key') || '';
        document.getElementById('conf-sender-name').value = localStorage.getItem('rave_conf-sender-name') || 'Raveone Consultants';
        document.getElementById('conf-reply-addr').value = localStorage.getItem('rave_conf-reply-addr') || 'noreply@raveone.in';
        document.getElementById('conf-unsubscribe-url').value = localStorage.getItem('rave_conf-unsubscribe-url') || 'https://yourdomain.com/unsubscribe?email=';
        document.getElementById('conf-gemini-key').value = localStorage.getItem('rave_conf-gemini-key') || '';
        document.getElementById('conf-spam-delay').value = localStorage.getItem('rave_conf-spam-delay') || '5';
        document.getElementById('conf-pixel').checked = localStorage.getItem('rave_conf-pixel') !== 'false';
        document.getElementById('conf-footer').value = localStorage.getItem('rave_conf-footer') || 
            `<br><hr><div style="font-size:12px; color:#666;">Raveone Consultants ¬∑ #32, 3rd Main, Nagarbhavi, Bangalore<br>To unsubscribe, <a href="{UNSUBSCRIBE_URL}">click here</a>.</div>`;
    });
</script>

<!-- Optional: logs container (add to dashboard later if desired) -->
<div id="logs" style="display: none;"></div>

</body>
</html>
