<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raveone ¬∑ Odoo‚ÄëStyle Desk</title>

    <!-- Oat UI ‚Äì base styles (we'll override for rectangular look) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/oat-ui@latest/dist/oat.min.css">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* ----- Odoo‚ÄëStyle Rectangular Design (Simplistic, Clean) ----- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f7fb;
            color: #333;
            line-height: 1.5;
        }
        [x-cloak] { display: none !important; }

        /* Layout */
        .odoo-layout { display: flex; min-height: 100vh; }

        /* Sidebar ‚Äì dark, rectangular, no rounded corners */
        .sidebar {
            width: 260px;
            background: #1e2b3c;
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .sidebar-header i {
            font-size: 1.75rem;
            color: #3b7a9e;
        }
        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
        }
        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0 0.75rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #ccc;
            font-weight: 500;
            transition: background 0.1s;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            border-radius: 0; /* rectangular */
        }
        .nav-item i { width: 1.5rem; color: #aaa; }
        .nav-item:hover { background: #2c3e50; color: #fff; }
        .nav-item.active { background: #3b7a9e; color: #fff; }
        .nav-item.active i { color: #fff; }

        /* Main content ‚Äì rectangular cards, no rounding */
        .main-content {
            flex: 1;
            padding: 2rem;
            background: #f5f7fb;
            overflow-y: auto;
        }

        /* Cards ‚Äì rectangular, subtle border, no shadow */
        .card {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* KPI grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .kpi-item {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
        }
        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        /* Form elements ‚Äì rectangular, simple */
        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: #fff;
            font-family: 'Inter', sans-serif;
            border-radius: 0; /* rectangular */
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b7a9e;
        }

        /* Buttons ‚Äì rectangular, clean */
        .btn {
            padding: 0.6rem 1.25rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 0;
        }
        .btn-primary {
            background: #3b7a9e;
            color: #fff;
        }
        .btn-primary:hover {
            background: #2c5f7a;
        }
        .btn-secondary {
            background: #f1f5f9;
            color: #1e293b;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
        }
        .table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .table tbody tr:hover {
            background: #f8fafc;
        }

        /* Status pills ‚Äì rectangular, no rounding */
        .status-pill {
            display: inline-block;
            padding: 0.2rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-pill.running { background: #dcfce7; color: #166534; }
        .status-pill.draft { background: #f1f5f9; color: #334155; }

        /* Modal overlay ‚Äì rectangular */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 2rem;
            width: 480px;
            max-width: 90%;
        }
    </style>
</head>
<body>

<!-- Alpine store -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('auth', { authenticated: false });
        Alpine.store('stats', { total: 0, quota: 0, pipelineValue: 0 });
        Alpine.store('campaigns', []);
        Alpine.store('deals', []);
        Alpine.store('templates', []);
        Alpine.store('contacts', []);
    });
</script>

<!-- Auth overlay -->
<div x-data="{ token: '' }" 
     x-show="!$store.auth.authenticated" 
     x-cloak
     class="modal-overlay">
    <div class="modal-content" style="width: 400px;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <i class="fas fa-cube" style="font-size: 2rem; color: #3b7a9e;"></i>
            <h2 style="font-size: 1.5rem; font-weight: 600; margin:0;">Raveone</h2>
        </div>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Enter your access token to continue.</p>
        <input type="password" x-model="token" placeholder="Access token" 
               style="width:100%; padding:0.75rem 1rem; border:1px solid #e2e8f0; margin-bottom:1.5rem;">
        <button @click="
            if (token === 'RAVE-ACCESS-2025') {
                $store.auth.authenticated = true;
                loadRealData();
            } else {
                alert('Access denied');
            }
        " class="btn btn-primary" style="width:100%;">
            <i class="fas fa-key"></i> Verify Access
        </button>
    </div>
</div>

<!-- Main layout -->
<div x-data="{ 
        activeNav: 'dashboard',
        showDealModal: false,
        showTemplateMenu: false,
        quill: null,
        isValidating: false,
        isCleaning: false
     }" 
     x-show="$store.auth.authenticated" 
     x-cloak
     class="odoo-layout"
     x-init="
        $watch('activeNav', value => {
            if (value === 'wizard' && !quill) {
                setTimeout(() => {
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ header: [1,2,3,false] }],
                                ['bold', 'italic', 'underline'],
                                ['link', 'clean']
                            ]
                        }
                    });
                }, 50);
            }
        });
     ">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-cube"></i>
            <h1>Raveone</h1>
        </div>
        <div class="sidebar-nav">
            <button @click="activeNav = 'dashboard'" 
                    class="nav-item" 
                    :class="{ 'active': activeNav === 'dashboard' }">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
            <button @click="activeNav = 'crm'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'crm' }">
                <i class="fas fa-users"></i>
                <span>CRM</span>
            </button>
            <button @click="activeNav = 'campaigns'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'campaigns' }">
                <i class="fas fa-paper-plane"></i>
                <span>Mailings</span>
            </button>
            <button @click="activeNav = 'templates'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'templates' }">
                <i class="fas fa-file-alt"></i>
                <span>Templates</span>
            </button>
            <button @click="activeNav = 'settings'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'settings' }">
                <i class="fas fa-cog"></i>
                <span>Configuration</span>
            </button>
            <button @click="activeNav = 'wizard'" 
                    class="nav-item"
                    :class="{ 'active': activeNav === 'wizard' }">
                <i class="fas fa-pen"></i>
                <span>Composer</span>
            </button>
        </div>
        <div style="padding: 1.5rem 1.5rem 0; border-top: 1px solid #2c3e50; margin-top: 1.5rem; color: #aaa; font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-cloud"></i>
                <span x-text="$store.stats.quota + ' / 1500 daily'"></span>
            </div>
            <div style="margin-top: 0.5rem;">
                <span x-text="$store.stats.total + ' contacts'"></span>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="main-content">

        <!-- Dashboard -->
        <div x-show="activeNav === 'dashboard'">
            <div class="kpi-grid">
                <div class="kpi-item">
                    <div class="kpi-label">Total Contacts</div>
                    <div class="kpi-value" x-text="$store.stats.total.toLocaleString()"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Pipeline Value</div>
                    <div class="kpi-value" x-text="'‚Çπ' + ($store.stats.pipelineValue || 0).toLocaleString()"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Daily Quota</div>
                    <div class="kpi-value" x-text="$store.stats.quota"></div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">Active Drips</div>
                    <div class="kpi-value" x-text="$store.campaigns.filter(c => c.status === 'Running').length"></div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 600;">üì¨ Recent Mailings</h3>
                    <button @click="activeNav = 'campaigns'" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New Campaign
                    </button>
                </div>
                <table class="table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Status</th><th>Limit</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="c in $store.campaigns.slice(0,3)" :key="c.id">
                            <tr>
                                <td x-text="c.name"></td>
                                <td x-text="c.subject"></td>
                                <td><span class="status-pill" :class="c.status?.toLowerCase()" x-text="c.status || 'Draft'"></span></td>
                                <td x-text="c.limit"></td>
                            </tr>
                        </template>
                        <tr x-show="$store.campaigns.length === 0">
                            <td colspan="4" style="text-align:center; color: #aaa;">No campaigns yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- CRM -->
        <div x-show="activeNav === 'crm'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Deal Pipeline</h2>
                <button @click="showDealModal = true" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Opportunity
                </button>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button class="btn btn-secondary">Recruitment</button>
                <button class="btn btn-secondary">Training</button>
                <button class="btn btn-secondary">Consulting</button>
            </div>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr><th>Opportunity</th><th>Company</th><th>Value</th><th>Contact</th><th>Stage</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="d in $store.deals" :key="d.id">
                            <tr>
                                <td><span style="font-weight:600;" x-text="d.name"></span></td>
                                <td x-text="d.business"></td>
                                <td x-text="'‚Çπ' + (d.value || 0).toLocaleString()"></td>
                                <td x-text="d.contactEmail || '‚Äî'"></td>
                                <td>
                                    <select @change="updateDealStage(d.id, $event.target.value)" 
                                            style="background: #f1f5f9; border: none; padding: 0.25rem 0.75rem;">
                                        <option value="New" :selected="d.stage === 'New'">New</option>
                                        <option value="Discovery" :selected="d.stage === 'Discovery'">Discovery</option>
                                        <option value="Proposal" :selected="d.stage === 'Proposal'">Proposal</option>
                                        <option value="Won" :selected="d.stage === 'Won'">Won</option>
                                    </select>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.deals.length === 0">
                            <td colspan="5" style="text-align:center; color: #aaa;">No deals yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Campaigns -->
        <div x-show="activeNav === 'campaigns'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Email Campaigns</h2>
                <button @click="activeNav = 'wizard'" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Create New
                </button>
            </div>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Segment</th><th>Limit</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody>
                        <template x-for="c in $store.campaigns" :key="c.id">
                            <tr>
                                <td x-text="c.name"></td>
                                <td x-text="c.subject"></td>
                                <td x-text="c.segment || 'All'"></td>
                                <td x-text="c.limit"></td>
                                <td><span class="status-pill" :class="c.status?.toLowerCase()" x-text="c.status || 'Draft'"></span></td>
                                <td>
                                    <button @click="toggleCampaignStatus(c.id)" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">
                                        <span x-text="c.status === 'Running' ? 'Stop' : 'Start'"></span>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.campaigns.length === 0">
                            <td colspan="6" style="text-align:center; color: #aaa;">No campaigns yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Templates -->
        <div x-show="activeNav === 'templates'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600;">Template Library</h2>
                <button @click="saveCurrentAsTemplate()" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Current
                </button>
            </div>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Category</th><th></th></tr>
                    </thead>
                    <tbody>
                        <template x-for="t in $store.templates" :key="t.id">
                            <tr>
                                <td x-text="t.name"></td>
                                <td x-text="t.subject"></td>
                                <td x-text="t.category || 'General'"></td>
                                <td>
                                    <button @click="useTemplate(t.id); activeNav = 'wizard'" class="btn btn-secondary" style="padding:0.25rem 0.75rem; margin-right:0.5rem;">Use</button>
                                    <button @click="deleteTemplate(t.id)" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">Delete</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="$store.templates.length === 0">
                            <td colspan="4" style="text-align:center; color: #aaa;">No templates yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings (with Hygiene Buttons) -->
        <div x-show="activeNav === 'settings'">
            <h2 style="font-size:1.25rem; font-weight:600; margin-bottom:1.5rem;">Configuration</h2>
            <div class="card">
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Apps Script URL</label>
                        <input type="text" id="conf-gas-url" placeholder="https://script.google.com/macros/s/AKfycby_M2yiFcD6sIev_F6ATl8kf_qB3AXR9I-DJvugVTHWEmYHEuE-OI3QI--helvev23GkQ/exec">
                    </div>
                    <div class="form-group">
                        <label>Master Key</label>
                        <input type="password" id="conf-master-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>Sender Name</label>
                        <input type="text" id="conf-sender-name" placeholder="Raveone Consultants">
                    </div>
                    <div class="form-group">
                        <label>Reply‚ÄëTo</label>
                        <input type="email" id="conf-reply-addr" placeholder="contact@yourdomain.com">
                    </div>
                    <div class="form-group">
                        <label>Unsubscribe URL</label>
                        <input type="url" id="conf-unsubscribe-url" placeholder="https://yourdomain.com/unsubscribe?email={EMAIL}">
                    </div>
                    <div class="form-group">
                        <label>Gemini API Key</label>
                        <input type="password" id="conf-gemini-key" placeholder="AI key">
                    </div>
                    <div class="form-group">
                        <label>Spam Delay</label>
                        <select id="conf-spam-delay">
                            <option value="1">1s (fast)</option>
                            <option value="5" selected>5s (recommended)</option>
                            <option value="10">10s (strict)</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="conf-pixel" checked> Enable tracking pixel
                        </label>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                    <label>HTML Signature / Footer</label>
                    <textarea id="conf-footer" rows="6" placeholder="<br><hr><div>... {UNSUBSCRIBE_URL} ...</div>"></textarea>
                    <p style="font-size:0.75rem; color: #aaa; margin-top:0.5rem;">Use {UNSUBSCRIBE_URL} placeholder. Saved to localStorage.</p>
                </div>

                <!-- Hygiene Buttons -->
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
                    <h3 style="font-size:1rem; font-weight:600; margin-bottom:1rem;">üìã Contact Hygiene</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button @click="runValidation()" 
                                :disabled="isValidating"
                                class="btn btn-primary"
                                style="min-width: 180px;">
                            <i class="fas fa-shield-alt"></i>
                            <span x-show="!isValidating">Run DNS Validation</span>
                            <span x-show="isValidating"><i class="fas fa-spinner fa-spin"></i> Validating...</span>
                        </button>
                        <button @click="runBounceClean()" 
                                :disabled="isCleaning"
                                class="btn btn-secondary"
                                style="min-width: 180px;">
                            <i class="fas fa-broom"></i>
                            <span x-show="!isCleaning">Clean Bounces</span>
                            <span x-show="isCleaning"><i class="fas fa-spinner fa-spin"></i> Cleaning...</span>
                        </button>
                    </div>
                    <p style="font-size:0.75rem; color: #aaa; margin-top:0.75rem;">
                        DNS validation checks syntax & MX records, updates "Email Valid" column.<br>
                        Clean Bounces marks all contacts with "Email Valid = FALSE" as Bounced.
                    </p>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
                    <button @click="saveSettings()" class="btn btn-primary">Save All Settings</button>
                </div>
            </div>
        </div>

        <!-- Wizard -->
        <div x-show="activeNav === 'wizard'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size:1.25rem; font-weight:600;">Compose New Mailing</h2>
                <div style="display: flex; gap: 0.75rem;">
                    <div style="position: relative;">
                        <button @click="showTemplateMenu = !showTemplateMenu" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Load Template
                        </button>
                        <div x-show="showTemplateMenu" @click.away="showTemplateMenu = false" 
                             style="position: absolute; right: 0; top: 100%; width: 280px; background: #fff; border: 1px solid #e2e8f0; padding: 0.5rem; margin-top: 0.25rem; z-index: 50;">
                            <template x-for="t in $store.templates" :key="t.id">
                                <button @click="useTemplate(t.id); showTemplateMenu = false" style="display: block; width:100%; text-align: left; padding: 0.5rem; background: none; border: none;" class="btn-secondary">
                                    <span x-text="t.name"></span>
                                </button>
                            </template>
                            <div x-show="$store.templates.length === 0" style="padding:0.5rem; color: #aaa;">No templates saved</div>
                        </div>
                    </div>
                    <button @click="refineAI()" class="btn btn-primary" style="background: linear-gradient(135deg,#6366f1,#a855f7);">‚ú® AI Refine</button>
                </div>
            </div>

            <div class="card" style="padding: 2rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <input type="text" id="campName" placeholder="Campaign name" 
                               style="font-size: 1.5rem; font-weight: 600; border: none; border-bottom: 2px solid #e2e8f0; width:100%; padding: 0.25rem 0;">
                        <input type="text" id="subA" placeholder="Email subject" style="margin-top: 1rem; width:100%;">
                    </div>
                    <div style="background: #f8fafc; padding: 1.5rem;">
                        <div style="display: flex; gap: 1rem;">
                            <div style="flex:1;">
                                <label style="font-size:0.75rem; color: #6b7280;">DAILY LIMIT</label>
                                <input type="number" id="campLimit" value="300" style="width:100%;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:0.75rem; color: #6b7280;">SEGMENT (tag)</label>
                                <input type="text" id="campSegment" placeholder="e.g. MSME" style="width:100%;">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="font-size:0.75rem; color: #6b7280;">Variables:</span>
                        <button @click="insertTag('{Name}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ Name</button>
                        <button @click="insertTag('{Business}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ Business</button>
                        <button @click="insertTag('{City}')" class="btn btn-secondary" style="padding:0.25rem 0.75rem;">+ City</button>
                    </div>
                    <button @click="checkSpam()" class="btn btn-secondary" style="color:#b45309;">‚ö†Ô∏è Check Spam</button>
                </div>

                <div id="editor" style="height: 320px;"></div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button @click="activeNav = 'campaigns'" class="btn btn-secondary">Cancel</button>
                    <button @click="saveCampaign()" class="btn btn-primary">Save & Sync</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Deal Modal -->
    <div x-show="showDealModal" x-cloak class="modal-overlay" @click.away="showDealModal = false">
        <div class="modal-content">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">Create Opportunity</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="text" id="dealName" placeholder="Deal name">
                <input type="text" id="dealCompany" placeholder="Company / Business">
                <input type="number" id="dealValue" placeholder="Value (‚Çπ)">
                <select id="dealPipeline">
                    <option value="Recruitment">Recruitment</option>
                    <option value="Training">Training</option>
                    <option value="Consulting">Consulting</option>
                </select>
                <select id="dealStage">
                    <option value="New">New</option>
                    <option value="Discovery">Discovery</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Won">Won</option>
                </select>
                <select id="dealContactEmail">
                    <option value="">-- Link to contact (optional) --</option>
                    <template x-for="contact in $store.contacts" :key="contact.email">
                        <option :value="contact.email" x-text="contact.name + ' (' + contact.email + ')'"></option>
                    </template>
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <button @click="showDealModal = false" class="btn btn-secondary">Cancel</button>
                <button @click="saveDeal(); showDealModal = false" class="btn btn-primary">Create Deal</button>
            </div>
        </div>
    </div>
</div>

<!-- JSONP & API Helpers -->
<script>
    // JSONP
    function jsonp(url) {
        return new Promise((resolve, reject) => {
            const cbName = 'jsonp_cb_' + Date.now() + '_' + Math.random().toString(36).substring(2,7);
            window[cbName] = function(data) {
                resolve(data);
                delete window[cbName];
                if (script.parentNode) script.parentNode.removeChild(script);
            };
            const script = document.createElement('script');
            const separator = url.includes('?') ? '&' : '?';
            script.src = url + separator + 'callback=' + cbName;
            script.onerror = () => reject(new Error('JSONP failed'));
            document.head.appendChild(script);
            setTimeout(() => {
                if (window[cbName]) {
                    reject(new Error('JSONP timeout'));
                    delete window[cbName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                }
            }, 15000);
        });
    }

    async function apiCall(action, params = {}) {
        const url = document.getElementById('conf-gas-url')?.value;
        if (!url) throw new Error('Apps Script URL not configured');
        const key = document.getElementById('conf-master-key')?.value || 'vibe-marketing-2024';
        const searchParams = new URLSearchParams({ action, key, ...params });
        Object.keys(params).forEach(k => {
            if (typeof params[k] === 'object') searchParams.set(k, JSON.stringify(params[k]));
        });
        const fullUrl = `${url}?${searchParams.toString()}`;
        const response = await jsonp(fullUrl);
        if (response?.error) throw new Error(response.error);
        return response;
    }

    // Data loader
    window.loadRealData = async function() {
        try {
            log('Loading real data from backend...');
            const [stats, campaigns, deals, contacts, templates] = await Promise.all([
                apiCall('getStatus').catch(() => ({ total: 0, quota: 0, pipelineValue: 0 })),
                apiCall('getCampaigns').catch(() => []),
                apiCall('getDeals').catch(() => []),
                apiCall('getContacts').catch(() => []),
                apiCall('getTemplates').catch(() => [])
            ]);
            Alpine.store('stats', stats);
            Alpine.store('campaigns', Array.isArray(campaigns) ? campaigns : []);
            Alpine.store('deals', Array.isArray(deals) ? deals : []);
            Alpine.store('contacts', Array.isArray(contacts) ? contacts : []);
            Alpine.store('templates', Array.isArray(templates) ? templates : []);
            log(`Data loaded: ${stats.total} contacts, ${deals.length} deals, ${campaigns.length} campaigns`);
        } catch (e) {
            log('Failed to load data: ' + e.message);
        }
    };

    // Hygiene functions
    window.runValidation = async function() {
        const alpine = Alpine.$data(document.querySelector('[x-data*="activeNav"]'));
        if (!alpine) return;
        alpine.isValidating = true;
        try {
            const result = await apiCall('validateAllEmails');
            log(`DNS validation complete: ${result.validated} contacts checked.`);
            const stats = await apiCall('getStatus');
            Alpine.store('stats', stats);
        } catch (e) {
            log('Validation error: ' + e.message);
            alert('Validation failed: ' + e.message);
        } finally {
            alpine.isValidating = false;
        }
    };

    window.runBounceClean = async function() {
        const alpine = Alpine.$data(document.querySelector('[x-data*="activeNav"]'));
        if (!alpine) return;
        alpine.isCleaning = true;
        try {
            const result = await apiCall('scanAndCleanBounces');
            log(`Bounce clean complete: ${result.cleaned} contacts marked as bounced.`);
            const stats = await apiCall('getStatus');
            Alpine.store('stats', stats);
        } catch (e) {
            log('Bounce clean error: ' + e.message);
            alert('Bounce clean failed: ' + e.message);
        } finally {
            alpine.isCleaning = false;
        }
    };

    // Other actions (identical to previous version)
    window.saveDeal = async function() {
        const newDeal = {
            id: Date.now().toString(),
            name: document.getElementById('dealName')?.value,
            business: document.getElementById('dealCompany')?.value,
            value: document.getElementById('dealValue')?.value,
            pipeline: document.getElementById('dealPipeline')?.value,
            stage: document.getElementById('dealStage')?.value,
            contactEmail: document.getElementById('dealContactEmail')?.value
        };
        try {
            await apiCall('saveDeal', { deal: newDeal });
            const deals = await apiCall('getDeals');
            Alpine.store('deals', deals);
            log('Deal created and synced');
        } catch(e) {
            console.error(e);
            alert('Failed to save deal: ' + e.message);
        }
    };

    window.updateDealStage = async function(id, stage) {
        try {
            await apiCall('updateDealStage', { id, stage });
            const deal = Alpine.store('deals').find(d => d.id == id);
            if (deal) deal.stage = stage;
        } catch(e) {
            console.error(e);
            alert('Failed to update stage: ' + e.message);
        }
    };

    window.toggleCampaignStatus = async function(id) {
        const campaign = Alpine.store('campaigns').find(c => c.id == id);
        const newStatus = campaign?.status === 'Running' ? 'Draft' : 'Running';
        try {
            await apiCall('toggleCampaignStatus', { id, status: newStatus });
            if (campaign) campaign.status = newStatus;
        } catch(e) {
            console.error(e);
            alert('Failed to toggle status: ' + e.message);
        }
    };

    window.saveCampaign = async function() {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        const body = quillEl?.root?.innerHTML || '';
        const signature = document.getElementById('conf-footer')?.value || '';
        const unsubscribeBase = document.getElementById('conf-unsubscribe-url')?.value || '';
        const finalBody = body + signature.replace(/{UNSUBSCRIBE_URL}/g, unsubscribeBase + '{EMAIL}');
        
        const newCampaign = {
            name: document.getElementById('campName')?.value || 'New Campaign',
            subject: document.getElementById('subA')?.value || 'No subject',
            body: finalBody,
            limit: document.getElementById('campLimit')?.value || 300,
            segment: document.getElementById('campSegment')?.value || ''
        };
        try {
            await apiCall('saveCampaign', { campaign: newCampaign });
            log('Campaign saved');
            const campaigns = await apiCall('getCampaigns');
            Alpine.store('campaigns', campaigns);
            Alpine.$data(document.querySelector('[x-data*="activeNav"]')).activeNav = 'campaigns';
        } catch(e) {
            console.error(e);
            alert('Failed to save campaign: ' + e.message);
        }
    };

    window.saveCurrentAsTemplate = async function() {
        const name = prompt('Template name:');
        if (!name) return;
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        const subject = document.getElementById('subA')?.value || '';
        const body = quillEl?.root?.innerHTML || '';
        const category = prompt('Category:') || 'General';
        try {
            await apiCall('saveTemplate', { template: { name, subject, body, category } });
            log('Template saved');
            const templates = await apiCall('getTemplates');
            Alpine.store('templates', templates);
        } catch(e) {
            console.error(e);
            alert('Failed to save template: ' + e.message);
        }
    };

    window.deleteTemplate = async function(id) {
        if (!confirm('Delete template?')) return;
        try {
            await apiCall('deleteTemplate', { id });
            Alpine.store('templates', Alpine.store('templates').filter(t => t.id != id));
        } catch(e) {
            console.error(e);
            alert('Failed to delete template: ' + e.message);
        }
    };

    window.useTemplate = function(id) {
        const t = Alpine.store('templates').find(t => t.id == id);
        if (t) {
            document.getElementById('campName').value = t.name + ' (Copy)';
            document.getElementById('subA').value = t.subject;
            const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
            if (quillEl) quillEl.clipboard.dangerouslyPasteHTML(t.body);
        }
    };

    window.refineAI = async function() {
        const key = document.getElementById('conf-gemini-key')?.value;
        if (!key) return alert('Gemini API key not configured');
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (!quillEl) return;
        const text = quillEl.getText();
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: 'Rewrite this for an MSME business owner. Be persuasive, direct, professional:\n' + text }] }] })
            });
            const data = await res.json();
            quillEl.root.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
            log('AI refinement applied');
        } catch(e) {
            console.error(e);
            alert('AI refinement failed: ' + e.message);
        }
    };

    window.insertTag = function(tag) {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (quillEl) {
            const range = quillEl.getSelection(true);
            quillEl.insertText(range?.index || quillEl.getLength(), tag);
        }
    };

    window.checkSpam = function() {
        const quillEl = Alpine.$data(document.querySelector('[x-data*="quill"]'))?.quill;
        if (!quillEl) return;
        const text = quillEl.getText().toLowerCase();
        const triggers = ['free','guarantee','winner','urgent','$$$','click here','act now','buy now','100%'];
        const found = triggers.filter(t => text.includes(t));
        alert(found.length ? '‚ö†Ô∏è Spam triggers: ' + found.join(', ') : '‚úÖ Clean');
    };

    window.saveSettings = function() {
        const ids = ['conf-gas-url','conf-master-key','conf-sender-name','conf-reply-addr',
                     'conf-unsubscribe-url','conf-gemini-key','conf-spam-delay','conf-footer'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) localStorage.setItem('rave_' + id, el.value);
        });
        localStorage.setItem('rave_conf-pixel', document.getElementById('conf-pixel')?.checked || false);
        alert('Settings saved to localStorage');
    };

    window.log = function(msg) {
        console.log('[Raveone]', msg);
        const logsEl = document.getElementById('logs');
        if (logsEl) logsEl.innerHTML = `> ${new Date().toLocaleTimeString()}: ${msg}<br>` + logsEl.innerHTML;
    };

    // Load settings from localStorage
    window.addEventListener('load', () => {
        const defaultUrl = 'https://script.google.com/macros/s/AKfycby_M2yiFcD6sIev_F6ATl8kf_qB3AXR9I-DJvugVTHWEmYHEuE-OI3QI--helvev23GkQ/exec'; // REPLACE WITH YOUR DEPLOYED URL
        document.getElementById('conf-gas-url').value = localStorage.getItem('rave_conf-gas-url') || defaultUrl;
        document.getElementById('conf-master-key').value = localStorage.getItem('rave_conf-master-key') || '';
        document.getElementById('conf-sender-name').value = localStorage.getItem('rave_conf-sender-name') || 'Raveone Consultants';
        document.getElementById('conf-reply-addr').value = localStorage.getItem('rave_conf-reply-addr') || 'noreply@raveone.in';
        document.getElementById('conf-unsubscribe-url').value = localStorage.getItem('rave_conf-unsubscribe-url') || 'https://yourdomain.com/unsubscribe?email=';
        document.getElementById('conf-gemini-key').value = localStorage.getItem('rave_conf-gemini-key') || '';
        document.getElementById('conf-spam-delay').value = localStorage.getItem('rave_conf-spam-delay') || '5';
        document.getElementById('conf-pixel').checked = localStorage.getItem('rave_conf-pixel') !== 'false';
        document.getElementById('conf-footer').value = localStorage.getItem('rave_conf-footer') || 
            `<br><hr><div style="font-size:12px; color:#666;">Raveone Consultants ¬∑ #32, 3rd Main, Nagarbhavi, Bangalore<br>To unsubscribe, <a href="{UNSUBSCRIBE_URL}">click here</a>.</div>`;
    });
</script>

<!-- hidden logs container -->
<div id="logs" style="display: none;"></div>
</body>
</html>
